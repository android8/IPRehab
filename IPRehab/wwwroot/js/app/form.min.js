import{Utility,UserAnswer,AjaxPostbackModel}from"./commonImport.js";const commonUtility=new Utility,formController=function(){let e;function t(e,t){const o=$(e.siblings("i.score"));t<=0?o.length>0&&o.remove():0===o.length?e.parent().closest("div").append("<i class='score'>score: "+t+"<i>"):o.text("score: "+t)}function o(){let e=0;return $(".persistable[id^=GG0170]:not([id*=Discharge_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){const o=$(this),n=commonUtility.getControlValue(o),i=o.prop("id");switch(!0){case n>=7:i.indexOf("GG0170I")>=0?t(o,0):(t(o,1),e+=1);break;case n>0&&n<=6:t(o,n),e+=n;break;default:t(o,0)}}),e}function n(e){let o,n,i,a=1,r=0,s=0,l=0,c=0,d=0;return"Base"===e?(o=$(".persistable[id^=GG0170I_Admission_Performance]"),n=$(".persistable[id^=GG0170R_Admission_Performance]"),i=$(".persistable[id^=GG0170S_Admission_Performance]")):(o=$(".persistable[id^=GG0170I_Interim_Performance], .persistable[id^=GG0170I_Follow_Up_Performance]"),n=$(".persistable[id^=GG0170R_Interim_Performance], .persistable[id^=GG0170R_Follow_Up_Performance]"),i=$(".persistable[id^=GG0170S_Interim_Performance], .persistable[id^=GG0170S_Follow_Up_Performance]")),(l=commonUtility.getControlValue(o))>=7&&(a=2),l<=6&&(a=0),isNaN(l)&&(a=1),(c=commonUtility.getControlValue(n))>0?(t(n,c*a),r+=c*a):t(n,0),(d=commonUtility.getControlValue(i))>0?(t(i,d*a),s+=d*a):t(i,0),r+s}return function(e){e[e.Elaborated=0]="Elaborated",e[e.Simple=1]="Simple"}(e||(e={})),{scrollToAnchor:function(e){const t=$("#"+e).prop("offsetTop");$("html,body").animate({scrollTop:t},"fast")},breakLongSentence:function(e){const t=e.next("div.longTextOption"),o=e[0].clientWidth,n=e;parseInt(e.prop("value"))<=0?t.text(""):$.each($("option:selected",n),function(){const e=$(this),n=new RegExp("([\\w\\s]{48,}?\\w)\\s?\\b","g"),i=e.text(),a=e.css("font"),r=commonUtility.getTextPixels(i,a);if(t.text(""),r>o){let e=i.replace(n,"$1\n");e=e.trim(),$.isNumeric(e.substring(0,1))&&(e=e.substring(e.indexOf(" ")+1)),t.text(e),t.removeClass("invisible")}})},submitTheForm:function(t,o){t.attr("disabled","true"),$(".spinnerContainer").show();const n=new Array,i=new Array,a=new Array,r=$("#userAnswerForm"),s=$("#patientID",r).val().toString(),l=$("#patientName",r).val().toString();let c=$("#facilityID",r).val().toString(),d=+$("#episodeID",r).val();const g=new Date($(".persistable[id^=Q23]").val().toString()),_=new Date($(".persistable[id^=Q12_]").val().toString());if(c){const e=c.split("(")[2],t=e.indexOf(")");c=e.substr(0,t)}const m=$(".persistable");let f=0;m.each(function(){var t,o;f++;const r=$(this),c=r.data("questionkey"),m=new UserAnswer,u=null===(t=r.data("oldvalue"))||void 0===t?void 0:t.toString();let h="";if(-1==+(h=null===(o=commonUtility.getControlValue(r,e.Simple))||void 0===o?void 0:o.toString())&&(h=""),commonUtility.isTheSame(r,u,h))return;console.log("--------- continue (not equal) ---------");const p=+r.data("questionid"),b=r.prop("type"),S=r.data("answerid"),A=+r.data("measureid"),G=r.data("measuredescription"),x=r.data("codesetdescription"),C=+r.data("answersequence"),D=r.data("userid");switch(m.PatientName=l,m.PatientID=s,m.EpisodeID=d,m.OnsetDate=g,m.AdmissionDate=_,m.QuestionID=p,m.QuestionKey=c,m.MeasureID=A,m.MeasureName=G,m.AnswerCodeSetDescription=x,C&&(m.AnswerSequenceNumber=C),m.AnswerByUserID=D,m.LastUpdate=new Date,b){case"text":case"date":case"textarea":case"number":m.AnswerCodeSetID=+r.data("codesetid"),m.OldAnswerCodeSetID=+r.data("codesetid"),m.Description=h;break;default:m.AnswerCodeSetID=+h,m.OldAnswerCodeSetID=+u}switch(console.log("("+f+") "+c,m),commonUtility.getCRUD(r,u,h)){case"C":i.push(m);break;case"D1":case"D2":m.AnswerID=+S,n.push(m);break;case"U":m.AnswerID=+S,a.push(m)}}),0!==i.length&&0!==n.length&&0!==a.length||$("#dialog").text("Nothing to save.  All fields seem be unchanged").dialog(o),$(".spinnerContainer").hide();const u=new AjaxPostbackModel;u.EpisodeID=d,u.FacilityID=c,u.NewAnswers=i,u.OldAnswers=n,u.UpdatedAnswers=a,console.log("postBackModel",u);const h=t.data("apibaseurl"),p=t.data("controller");let b;b=-1===d?h+"/api/"+p+"/PostNewEpisode":h+"/api/"+p,$(".spinnerContainer").show(),function(e,n,i){$.ajax({type:"POST",url:e,data:JSON.stringify(n),headers:{RequestVerificationToken:$("input[name=X-CSRF-TOKEN-IPREHAB]").val().toString(),Accept:"application/json"},contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0}).done(function(e){$(".spinnerContainer").hide(),console.log("postback result",e);const t=$.parseJSON(e);console.log("jsonResult",t),-1===i&&($("#episodeID").val(t),$("#stage").val("Base")),o.title="Success",$("#dialog").text("Data is saved.").dialog(o)}).fail(function(e){$(".spinnerContainer").hide(),t.attr("disabled","false"),console.log("postback error",e),o.title=e.statusText,"OK"===e.statusText||"Ok"===e.statusText?$("#dialog").text("Data is saved.").dialog(o):$("#dialog").text("Data is not saved. "+e.responseText).dialog(o)})}(b,u,d)},validate:function(e){e.validate()},selfCareScore:function(){let e=0,o=0,n=0;$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){const i=$(this),a=$(this).prop("id"),r=commonUtility.getControlValue(i);switch(!0){case r>=7:t(i,1),a.indexOf("Admission")>=0?e+=1:a.indexOf("Discharge")>=0?o+=1:n+=1;break;case r>0&&r<=6:t(i,r),a.indexOf("Admission")>=0?e+=r:a.indexOf("Discharge")>=0?o+=r:n+=r;break;default:t(i,0)}}),$("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Self_Care_Aggregate_Score_Discharge_Performance").length>0?($("#Self_Care_Aggregate_Score_Admission_Performance").text(e),$("#Self_Care_Aggregate_Score_Discharge_Performance").text(o),$("#Self_Care_Aggregate_Score_Total_Change").text(o-e)):$("#Self_Care_Aggregate_Score").text(n)},mobilityScore:function(){if($("#Mobility_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Discharge_Performance").length>0){let e=0,i=0;e+=o(),e+=n("Base"),i+=function(){let e=0;return $(".persistable[id^=GG0170]:not([id*=Admission_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){const o=$(this),n=commonUtility.getControlValue(o),i=o.prop("id");switch(!0){case n>=7:i.indexOf("GG0170I")>=0?t(o,0):(t(o,1),e+=1);break;case n>0&&n<=6:t(o,n),e+=n;break;default:t(o,0)}}),e}(),i+=function(){let e=1,o=0,n=0;const i=$(".persistable[id^=GG0170I_Discharge_Performance]"),a=commonUtility.getControlValue(i);a>=7&&(e=2),a<=6&&(e=0),isNaN(a)&&(e=1);const r=$(".persistable[id^=GG0170R_Discharge_Performance]"),s=commonUtility.getControlValue(r);s>0?(t(r,s*e),o+=s*e):t(r,0);const l=$(".persistable[id^=GG0170S_Discharge_Performance]"),c=commonUtility.getControlValue(l);return c>0?(t(l,c*e),n+=c*e):t(l,0),o+n}(),$("#Mobility_Aggregate_Score_Admission_Performance").text(e),$("#Mobility_Aggregate_Score_Discharge_Performance").text(i),$("#Mobility_Aggregate_Score_Total_Change").text(i-e)}else{let e=0;e+=o(),e+=n("Interim or Follow Up"),$("#Mobility_Aggregate_Score").text(e)}},updateScore:t,grandTotal:function(){let e=0;if($("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Admission_Performance").length>0){const t=$("#Self_Care_Aggregate_Score_Admission_Performance").text(),o=parseInt(t),n=$("#Mobility_Aggregate_Score_Admission_Performance").text(),i=o+parseInt(n);$("#Admission_Performance_Grand_Total").length>0&&$("#Admission_Performance_Grand_Total").text(i);const a=$("#Self_Care_Aggregate_Score_Discharge_Performance").text(),r=parseInt(a),s=$("#Mobility_Aggregate_Score_Discharge_Performance").text(),l=r+parseInt(s);$("#Discharge_Performance_Grand_Total").length>0&&$("#Discharge_Performance_Grand_Total").text(l),e=l-i}else{const t=$("#Self_Care_Aggregate_Score").text(),o=parseInt(t),n=$("#Mobility_Aggregate_Score").text();e=o+parseInt(n)}$("#Grand_Total").length>0&&$("#Grand_Total").text(e)}}}();$(function(){const e=commonUtility.dialogOptions();$(".bi-calendar-x").on("click",function(){const e=$(this).data("target"),t=$("#"+e);console.log("calendar reset "+t.prop("id")),t.length>0&&(e.indexOf("Q12B")>0?(console.log("raise change() and let branching.Q12B_blank_then_Lock_Discharge() open a dialog before reset"),$("[id^=Q12B_").change()):commonUtility.resetControlValue(t))}),$("select").each(function(){const e=$(this);e.on("change",function(){-1!==e.val()&&formController.breakLongSentence(e)})}),$("#questionTab").hover(function(){$("#questionTab").css({left:"0px","transition-duration":"1s"})},function(){$("#questionTab").css({left:"-245px","transition-duration":"1s"})}),$(".gotoSection").each(function(){const e=$(this);e.click(function(){const t=e.data("anchorid");""!=t&&formController.scrollToAnchor(t)})}),$(".section-title").each(function(){const e=$(this);e.click(function(){let t=e.next(),o=t.attr("hidden");t.attr("hidden",!o)})}),$(".child1").each(function(){const e=$(this);e.click(function(){const t=e.next();console.log("thisQuestion",t);const o=t.attr("hidden");console.log("thisQuestion hidden",o),t.attr("hidden",!o)})}),$(".persistable:not([id*=Discharge_Goal])").on("change",function(e){$("#ajaxPost").removeAttr("disabled")}),$("#ajaxPost").click(function(){formController.validate&&formController.submitTheForm($(this),e)}),formController.selfCareScore(),$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){$(this).on("change",function(){formController.selfCareScore(),formController.grandTotal()})}),formController.mobilityScore(),$(".persistable[id^=GG0170]:not([id*=Discharge_Goal])").each(function(){$(this).on("change",function(){formController.mobilityScore(),formController.grandTotal()})}),formController.grandTotal()});