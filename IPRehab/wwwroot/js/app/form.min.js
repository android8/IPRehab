import{Utility,UserAnswer,AjaxPostbackModel}from"./commonImport.js";const commonUtility=new Utility,formController=function(){let e;function t(e,t){const o=$(e.siblings("i.score"));t<=0?o.length>0&&o.remove():0===o.length?e.parent().closest("div").append("<i class='score'>score: "+t+"<i>"):o.text("score: "+t)}function o(){let e=0;return $(".persistable[id^=GG0170]:not([id*=Discharge_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){const o=$(this),i=commonUtility.getControlValue(o),n=o.prop("id");switch(!0){case i>=7:n.indexOf("GG0170I")>=0?t(o,0):(t(o,1),e+=1);break;case i>0&&i<=6:t(o,i),e+=i;break;default:t(o,0)}}),e}function i(e){let o,i,n,r=1,a=0,s=0,l=0,c=0,g=0;return"Base"===e?(o=$(".persistable[id^=GG0170I_Admission_Performance]"),i=$(".persistable[id^=GG0170R_Admission_Performance]"),n=$(".persistable[id^=GG0170S_Admission_Performance]")):(o=$(".persistable[id^=GG0170I_Interim_Performance], .persistable[id^=GG0170I_Follow_Up_Performance]"),i=$(".persistable[id^=GG0170R_Interim_Performance], .persistable[id^=GG0170R_Follow_Up_Performance]"),n=$(".persistable[id^=GG0170S_Interim_Performance], .persistable[id^=GG0170S_Follow_Up_Performance]")),(l=commonUtility.getControlValue(o))>=7&&(r=2),l<=6&&(r=0),isNaN(l)&&(r=1),(c=commonUtility.getControlValue(i))>0?(t(i,c*r),a+=c*r):t(i,0),(g=commonUtility.getControlValue(n))>0?(t(n,g*r),s+=g*r):t(n,0),a+s}return function(e){e[e.Elaborated=0]="Elaborated",e[e.Simple=1]="Simple"}(e||(e={})),{scrollToAnchor:function(e){!function(e){let t=e.prop("offsetTop")+15;-1!==e.prop("id").indexOf("Q12")&&(t=0),console.log("scroll to "+e.prop("id")+", amount "+t,e),$("html,body").animate({scrollTop:t},"fast"),e.focus()}($("#"+e))},breakLongSentence:function(e){const t=e.next("div.longTextOption"),o=e[0].clientWidth,i=e;parseInt(e.prop("value"))<=0?t.text(""):$.each($("option:selected",i),function(){const e=$(this),i=new RegExp("([\\w\\s]{48,}?\\w)\\s?\\b","g"),n=e.text(),r=e.css("font"),a=commonUtility.getTextPixels(n,r);if(t.text(""),a>o){let e=n.replace(i,"$1\n");e=e.trim(),$.isNumeric(e.substring(0,1))&&(e=e.substring(e.indexOf(" ")+1)),t.text(e),t.removeClass("invisible")}})},submitTheForm:function(t,o){var i,n,r,a;t.attr("disabled","true"),$(".spinnerContainer").show();const s=new Array,l=new Array,c=new Array,g=$("#userAnswerForm"),d=null===(i=$("#stage",g).val())||void 0===i?void 0:i.toString(),_=null===(n=$("#patientID",g).val())||void 0===n?void 0:n.toString(),m=null===(r=$("#patientName",g).val())||void 0===r?void 0:r.toString();let f=null===(a=$("#facilityID",g).val())||void 0===a?void 0:a.toString(),u=+$("#episodeID",g).val();"New"===d&&(u=-1);const p=new Date($(".persistable[id^=Q23]").val().toString()),h=new Date($(".persistable[id^=Q12_]").val().toString());if(f){const e=f.split("(")[2],t=e.indexOf(")");f=e.substr(0,t)}const A=$(".persistable");let b=0;A.each(function(){var t,o;b++;const i=$(this),n=i.data("questionkey"),r=new UserAnswer,a=null===(t=i.data("oldvalue"))||void 0===t?void 0:t.toString();let g="";if(-1==+(g=null===(o=commonUtility.getControlValue(i,e.Simple))||void 0===o?void 0:o.toString())&&(g=""),commonUtility.isTheSame(i,a,g))return;console.log("--------- continue (not equal) ---------");const d=+i.data("questionid"),f=i.prop("type"),A=i.data("answerid"),S=+i.data("measureid"),x=i.data("measuredescription"),G=i.data("codesetdescription"),C=+i.data("answersequence"),y=i.data("userid");switch(r.PatientName=m,r.PatientID=_,r.EpisodeID=u,r.OnsetDate=p,r.AdmissionDate=h,r.QuestionID=d,r.QuestionKey=n,r.MeasureID=S,r.MeasureName=x,r.AnswerCodeSetDescription=G,C&&(r.AnswerSequenceNumber=C),r.AnswerByUserID=y,r.LastUpdate=new Date,f){case"text":case"date":case"textarea":case"number":r.AnswerCodeSetID=+i.data("codesetid"),r.OldAnswerCodeSetID=+i.data("codesetid"),r.Description=g;break;default:r.AnswerCodeSetID=+g,r.OldAnswerCodeSetID=+a}switch(console.log("("+b+") "+n,r),commonUtility.getCRUD(i,a,g)){case"C":l.push(r);break;case"D1":case"D2":r.AnswerID=+A,s.push(r);break;case"U":r.AnswerID=+A,c.push(r)}}),0===l.length&&0===s.length&&0===c.length&&$("#dialog").text("Nothing to save.  All fields seem be unchanged").dialog(o),$(".spinnerContainer").hide();const S=new AjaxPostbackModel;S.EpisodeID=u,S.FacilityID=f,S.NewAnswers=l,S.OldAnswers=s,S.UpdatedAnswers=c,console.log("postBackModel",S);const x=t.data("apibaseurl"),G=t.data("controller");let C;C=-1===u?x+"/api/"+G+"/PostNewEpisode":x+"/api/"+G,$(".spinnerContainer").show(),function(e,i,n){$.ajax({type:"POST",url:e,data:JSON.stringify(i),headers:{RequestVerificationToken:$("input[name=X-CSRF-TOKEN-IPREHAB]").val().toString(),Accept:"application/json"},contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0}).done(function(e){$(".spinnerContainer").hide(),console.log("postback result",e);const t=$.parseJSON(e);console.log("jsonResult",t),-1===n&&($("#episodeID").val(t),$("#stage").val("Base"),$("#pageTitle").text("Episode of Care"),$("#episodeID_legend").text(t)),o.title="Success",$("#dialog").text("Data is saved.").dialog(o)}).fail(function(e){$(".spinnerContainer").hide(),t.attr("disabled","false"),console.log("postback error",e),o.title=e.statusText,"OK"===e.statusText||"Ok"===e.statusText?$("#dialog").text("Data is saved.").dialog(o):$("#dialog").text("Data is not saved. "+e.responseText).dialog(o)})}(C,S,u)},validate:function(e){e.validate()},selfCareScore:function(){let e=0,o=0,i=0;$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){const n=$(this),r=$(this).prop("id"),a=commonUtility.getControlValue(n);switch(!0){case a>=7:t(n,1),r.indexOf("Admission")>=0?e+=1:r.indexOf("Discharge")>=0?o+=1:i+=1;break;case a>0&&a<=6:t(n,a),r.indexOf("Admission")>=0?e+=a:r.indexOf("Discharge")>=0?o+=a:i+=a;break;default:t(n,0)}}),$("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Self_Care_Aggregate_Score_Discharge_Performance").length>0?($("#Self_Care_Aggregate_Score_Admission_Performance").text(e),$("#Self_Care_Aggregate_Score_Discharge_Performance").text(o),$("#Self_Care_Aggregate_Score_Total_Change").text(o-e),$("#slidingAggregator #self_care_admission_score").text(e),$("#slidingAggregator #self_care_discharge_score").text(o),$("#slidingAggregator #self_care_total").text(o-e)):$("#Self_Care_Aggregate_Score").text(i)},mobilityScore:function(){if($("#Mobility_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Discharge_Performance").length>0){let e=0,n=0;e+=o(),e+=i("Base"),n+=function(){let e=0;return $(".persistable[id^=GG0170]:not([id*=Admission_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){const o=$(this),i=commonUtility.getControlValue(o),n=o.prop("id");switch(!0){case i>=7:n.indexOf("GG0170I")>=0?t(o,0):(t(o,1),e+=1);break;case i>0&&i<=6:t(o,i),e+=i;break;default:t(o,0)}}),e}(),n+=function(){let e=1,o=0,i=0;const n=$(".persistable[id^=GG0170I_Discharge_Performance]"),r=commonUtility.getControlValue(n);r>=7&&(e=2),r<=6&&(e=0),isNaN(r)&&(e=1);const a=$(".persistable[id^=GG0170R_Discharge_Performance]"),s=commonUtility.getControlValue(a);s>0?(t(a,s*e),o+=s*e):t(a,0);const l=$(".persistable[id^=GG0170S_Discharge_Performance]"),c=commonUtility.getControlValue(l);return c>0?(t(l,c*e),i+=c*e):t(l,0),o+i}(),$("#Mobility_Aggregate_Score_Admission_Performance").text(e),$("#Mobility_Aggregate_Score_Discharge_Performance").text(n),$("#Mobility_Aggregate_Score_Total_Change").text(n-e),$("#slidingAggregator #mobility_admission_score").text(e),$("#slidingAggregator #mobility_discharge_score").text(n),$("#slidingAggregator #mobility_total").text(n-e)}else{let e=0;e+=o(),e+=i("Interim or Follow Up"),$("#Mobility_Aggregate_Score").text(e)}},updateScore:t,grandTotal:function(){let e=0;if($("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Admission_Performance").length>0){const t=$("#Self_Care_Aggregate_Score_Admission_Performance").text(),o=parseInt(t),i=$("#Mobility_Aggregate_Score_Admission_Performance").text(),n=o+parseInt(i);$("#Admission_Performance_Grand_Total").length>0&&$("#Admission_Performance_Grand_Total").text(n),$("#slidingAggregator #admission_total").length>0&&$("#slidingAggregator #admission_total").text(n);const r=$("#Self_Care_Aggregate_Score_Discharge_Performance").text(),a=parseInt(r),s=$("#Mobility_Aggregate_Score_Discharge_Performance").text(),l=a+parseInt(s);$("#Discharge_Performance_Grand_Total").length>0&&$("#Discharge_Performance_Grand_Total").text(l),$("#slidingAggregator #discharge_total").length>0&&$("#slidingAggregator #discharge_total").text(l),e=l-n}else{const t=$("#Self_Care_Aggregate_Score").text(),o=parseInt(t),i=$("#Mobility_Aggregate_Score").text();e=o+parseInt(i)}$("#Grand_Total").length>0&&$("#Grand_Total").text(e),$("#slidingAggregator #grand_total").length>0&&$("#slidingAggregator #grand_total").text(e)}}}();$(function(){const e={resizable:!0,classes:{"ui-dialog":"my-dialog","ui-dialog-titlebar":"my-dialog-header"},modal:!0,stack:!0,sticky:!0,position:{my:"center",at:"center",of:window},buttons:[{text:"Close",click:function(){$(this).dialog("close")}}]};$(".calendarReset").on("click",function(){const e=$("#"+$(this).data("target"));console.log("reset "+e.prop("id"),e);const t=-1!==e.prop("id").indexOf("Q12B");e.length>0&&(e.val(""),t?(console.log("raise change() to let branching.Q12B_blank_then_Lock_Discharge() handle the change() event"),e.change()):(console.log("reset "+e.prop("type")+" "+e.prop("id")),commonUtility.resetControlValue(e)))}),$("select").each(function(){const e=$(this);e.on("change",function(){-1!==e.val()&&formController.breakLongSentence(e)})}),$("#questionTab").hover(function(){$("#questionTab").css({left:"0px","transition-duration":"1s"})},function(){$("#questionTab").css({left:"-245px","transition-duration":"1s"})}),$("#rotateSlidingAggregatorHandle").on("click",function(){$("#slidingAggregator").css("right","0px")}),$("#closeSlidingAggregator").on("click",function(){$("#slidingAggregator").css("right","-250px")}),$(".gotoSection").each(function(){const e=$(this);e.click(function(){const t=e.data("anchorid");""!=t&&formController.scrollToAnchor(t)})}),$(".section-title").each(function(){const e=$(this);e.click(function(){let t=e.next(),o=t.attr("hidden");t.attr("hidden",!o)})}),$(".child1").each(function(){const e=$(this);e.click(function(){const t=e.next();console.log("thisQuestion",t);const o=t.attr("hidden");console.log("thisQuestion hidden",o),t.attr("hidden",!o)})}),$(".persistable").on("change",function(e){$("#ajaxPost").removeAttr("disabled")}),$("#ajaxPost").click(function(){formController.validate&&formController.submitTheForm($(this),e)}),formController.selfCareScore(),$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){$(this).on("change",function(){formController.selfCareScore(),formController.grandTotal()})}),formController.mobilityScore(),$(".persistable[id^=GG0170]:not([id*=Discharge_Goal])").each(function(){$(this).on("change",function(){formController.mobilityScore(),formController.grandTotal()})}),formController.grandTotal()});