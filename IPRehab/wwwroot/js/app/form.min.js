import{Utility,UserAnswer,AjaxPostbackModel}from"./commonImport.js";const commonUtility=new Utility,formController=function(){let e;function t(e,t){console.log("thisControl score = "+t,e);const o=e.siblings("i.score");switch(!0){case(t<=0||isNaN(t))&&o.length>0:console.log("path1: remove the score"),o.remove();break;case t>0&&0===o.length:console.log("path2: append the score"),e.parent().closest("div").append("<i class='score'>score: "+t+"<i>");break;case t>0&&o.length>0:console.log("path3: update existing score"),o.text("score: "+t)}}function o(e){const o=$(".persistable[id^=GG0170I][id*="+e+"]"),i=commonUtility.getControlValue(o);console.log(o.prop("id")+" score = "+i);const n=$(".persistable[id^=GG0170][id*="+e+"]:not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])");let s=0;return n.each(function(){const o=$(this);console.log("----- begin update score for ",o.prop("id"));const n=commonUtility.getControlValue(o),r=o.prop("id").indexOf("GG0170I_"+e)>=0;switch(!0){case n>=7:r?(console.log("\t Score_GG0170AtoP_Performance::: path 1"),t(o,0)):(console.log("\t Score_GG0170AtoP_Performance::: path 2"),t(o,1),s+=1);break;case n>0&&n<7:if(r){console.log("\t Score_GG0170AtoP_Performance::: path 3 update I, R, S"),s+=i,t(o,n),t($(".persistable[id^=GG0170R_"+e+"]"),0),t($(".persistable[id^=GG0170S_"+e+"]"),0)}else console.log("\t Score_GG0170AtoP_Performance::: path 4"),t(o,n),s+=n;break;default:console.log("\t Score_GG0170AtoP_Performance::: default"),t(o,0)}console.log("\t after update "+o.prop("id")+" score = "+n)}),s}function i(e=""){let o,i,n,s=1,r=0,a=0,c=0,l=0,g=0;return o=$(".persistable[id^=GG0170I_"+e+"]"),i=$(".persistable[id^=GG0170R_"+e+"]"),n=$(".persistable[id^=GG0170S_"+e+"]"),c=commonUtility.getControlValue(o),l=commonUtility.getControlValue(i),g=commonUtility.getControlValue(n),c>=7?s=2:c>0&&c<7&&(s=0),l>=7&&(l=1),t(i,l*s),r+=l*s,console.log("GG0170R_Value_"+e+" * "+s+" = "+l*s),g>=7&&(g=1),t(n,g*s),a+=g*s,console.log("GG0170S_Value_"+e+" * "+s+" = "+g*s),r+a}return function(e){e[e.Elaborated=0]="Elaborated",e[e.Simple=1]="Simple"}(e||(e={})),{scrollToAnchor:function(e){!function(e){let t=e.prop("offsetTop")+15;-1!==e.prop("id").indexOf("Q12")&&(t=0),console.log("scroll to "+e.prop("id")+", amount "+t,e),$("html,body").animate({scrollTop:t},"fast"),e.focus()}($("#"+e))},breakLongSentence:function(e){const t=e.next("div.longTextOption"),o=e[0].clientWidth,i=e;parseInt(e.prop("value"))<=0?t.text(""):$.each($("option:selected",i),function(){const e=$(this),i=new RegExp("([\\w\\s]{48,}?\\w)\\s?\\b","g"),n=e.text(),s=e.css("font"),r=commonUtility.getTextPixels(n,s);if(t.text(""),r>o){let e=n.replace(i,"$1\n");e=e.trim(),$.isNumeric(e.substring(0,1))&&(e=e.substring(e.indexOf(" ")+1)),t.text(e),t.removeClass("invisible")}})},submitTheForm:function(t,o){var i,n,s,r;t.attr("disabled","true"),$(".spinnerContainer").show();const a=new Array,c=new Array,l=new Array,g=$("#userAnswerForm"),d=null===(i=$("#stage",g).val())||void 0===i?void 0:i.toString(),m=null===(n=$("#patientID",g).val())||void 0===n?void 0:n.toString(),p=null===(s=$("#patientName",g).val())||void 0===s?void 0:s.toString();let _=null===(r=$("#facilityID",g).val())||void 0===r?void 0:r.toString(),f=+$("#episodeID",g).val();"New"===d&&(f=-1);const h=new Date($(".persistable[id^=Q23]").val().toString()),u=new Date($(".persistable[id^=Q12_]").val().toString());if(console.log("facilityID",_),_&&-1!==_.indexOf("(")){const e=_.split("(")[1],t=e.indexOf(")");_=e.substr(0,t)}const b=$(".persistable");let S=0;b.each(function(){var t,o;S++;const i=$(this),n=i.data("questionkey"),s=new UserAnswer,r=null===(t=i.data("oldvalue"))||void 0===t?void 0:t.toString();let g="";if(-1==+(g=null===(o=commonUtility.getControlValue(i,e.Simple))||void 0===o?void 0:o.toString())&&(g=""),commonUtility.isTheSame(i,r,g))return;console.log("--------- continue (not equal) ---------");const d=+i.data("questionid"),_=i.prop("type"),b=i.data("answerid"),x=+i.data("measureid"),y=i.data("measuredescription"),w=i.data("codesetdescription"),A=+i.data("answersequence"),v=i.data("userid");switch(s.PatientName=p,s.PatientID=m,s.EpisodeID=f,s.OnsetDate=h,s.AdmissionDate=u,s.QuestionID=d,s.QuestionKey=n,s.MeasureID=x,s.MeasureName=y,s.AnswerCodeSetDescription=w,A&&(s.AnswerSequenceNumber=A),s.AnswerByUserID=v,s.LastUpdate=new Date,_){case"text":case"date":case"textarea":case"number":s.AnswerCodeSetID=+i.data("codesetid"),s.OldAnswerCodeSetID=+i.data("codesetid"),s.Description=g;break;default:s.AnswerCodeSetID=+g,s.OldAnswerCodeSetID=+r}switch(console.log("("+S+") "+n,s),commonUtility.getCRUD(i,r,g)){case"C":c.push(s);break;case"D1":case"D2":s.AnswerID=+b,a.push(s);break;case"U":s.AnswerID=+b,l.push(s)}}),0===c.length&&0===a.length&&0===l.length&&$("#dialog").text("Nothing to save.  All fields seem be unchanged").dialog(o),$(".spinnerContainer").hide();const x=new AjaxPostbackModel;x.EpisodeID=f,x.FacilityID=_,x.NewAnswers=c,x.OldAnswers=a,x.UpdatedAnswers=l,console.log("postBackModel",x);const y=t.data("apibaseurl"),w=t.data("controller");let A;!function(e,i,n){$.ajax({type:"POST",url:e,data:JSON.stringify(i),headers:{RequestVerificationToken:$("input[name=X-CSRF-TOKEN-IPREHAB]").val().toString(),Accept:"application/json","Access-Control-Allow-Origin":"*"},contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0}).done(function(e){$(".spinnerContainer").hide(),console.log("postback result",e);const t=$.parseJSON(e);let i;console.log("jsonResult",t),-1===n&&($("#episodeID").val(t),$("#stage").val("Base"),$("#pageTitle").text("Episode of Care"),$("#episodeID_legend").text(t),i="Note: When in NEW mode and after the record is saved, refreshing the screen will only show another new form.  To dobule confirm the record just saved, go back to Patient list and select the Episode of Care ID shown on the upper right of this form."),o.title="Success",$("#dialog").text("Data is saved."+i).dialog(o)}).fail(function(e){$(".spinnerContainer").hide(),t.attr("disabled","false"),console.log("postback error",e),o.title=e.statusText,"OK"===e.statusText||"Ok"===e.statusText?$("#dialog").text("Data is saved.").dialog(o):$("#dialog").text("Data is not saved. "+e.responseText).dialog(o)})}(A=-1===f?y+"/api/"+w+"/PostNewEpisode":y+"/api/"+w,x,f)},validate:function(e){e.validate()},selfCareScore:function(){let e=0,o=0,i=0;$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){const n=$(this),s=$(this).prop("id"),r=commonUtility.getControlValue(n);switch(!0){case r>=7:t(n,1),s.indexOf("Admission")>=0?e+=1:s.indexOf("Discharge")>=0?o+=1:i+=1;break;case r>0&&r<=6:t(n,r),s.indexOf("Admission")>=0?e+=r:s.indexOf("Discharge")>=0?o+=r:i+=r;break;default:t(n,0)}}),$(".scoreSection #self_care_aggregate_score_admission_performance").length>0&&$(".scoreSection #self_care_aggregate_score_discharge_performance").length>0?($(".scoreSection #self_care_aggregate_score_admission_performance").text(e),$(".scoreSection #self_care_aggregate_score_discharge_performance").text(o),$(".scoreSection #self_care_aggregate_score_total_change").text(o-e),$("#slidingAggregator #self_care_admission_score").text(e),$("#slidingAggregator #self_care_discharge_score").text(o),$("#slidingAggregator #self_care_total").text(o-e)):($(".scoreSection #self_care_aggregate_score").text(i),$("#slidingAggregator #self_care_aggregate_score").text(i))},mobilityScore:function(){switch(!0){case $(".scoreSection #mobility_aggregate_score_admission_performance").length>0:case $(".scoreSection #mobility_aggregate_score_discharge_performance").length>0:{let e=0,t=0;e+=o("Admission_Performance"),e+=i("Admission_Performance"),console.log("mobilityPerformance (Admission) = "+e),t+=o("Discharge_Performance"),t+=i("Discharge_Performance"),console.log("mobilityPerformance (Discharge) = "+t),$(".scoreSection #mobility_aggregate_score_admission_performance").text(e),$(".scoreSection #mobility_aggregate_score_discharge_performance").text(t),$(".scoreSection #mobility_aggregate_score_total_change").text(t-e),$("#slidingAggregator #mobility_admission_score").text(e),$("#slidingAggregator #mobility_discharge_score").text(t),$("#slidingAggregator #mobility_total").text(t-e)}break;case $(".persistable[id*=Interim]").length>0:{let e=0;e+=o("Interim_Performance"),e+=i("Interim_Performance"),console.log("mobilityPerformance (Interim) = "+e),$(".scoreSection #mobility_aggregate_score").text(e),$("#slidingAggregator #mobility_aggregate_score").text(e);break}case $(".persistable[id*=Follow_Up]").length>0:{let e=0;e+=o("Follow_Up_Performance"),e+=i("Follow_Up_Performance"),console.log("mobilityPerformance (Follow Up) = "+e),$(".scoreSection #mobility_aggregate_score").text(e),$("#slidingAggregator #mobility_aggregate_score").text(e);break}}},updateScore:t,grandTotal:function(){let e=0;if($(".scoreSection #self_care_aggregate_score_admission_performance").length>0&&$(".scoreSection #mobility_aggregate_score_admission_performance").length>0){const t=$(".scoreSection #self_care_aggregate_score_admission_performance").text(),o=parseInt(t),i=$(".scoreSection #mobility_aggregate_score_admission_performance").text(),n=o+parseInt(i);$(".scoreSection #admission_performance_grand_total").length>0&&$(".scoreSection #admission_performance_grand_total").text(n),$("#slidingAggregator #admission_total").length>0&&$("#slidingAggregator #admission_total").text(n);const s=$(".scoreSection #self_care_aggregate_score_discharge_performance").text(),r=parseInt(s),a=$(".scoreSection #mobility_aggregate_score_discharge_performance").text(),c=r+parseInt(a);$(".scoreSection #discharge_performance_grand_total").length>0&&$(".scoreSection #discharge_performance_grand_total").text(c),$("#slidingAggregator #discharge_total").length>0&&$("#slidingAggregator #discharge_total").text(c),e=c-n}else{const t=$(".scoreSection #self_care_aggregate_score").text(),o=parseInt(t),i=$(".scoreSection #mobility_aggregate_score").text();e=o+parseInt(i)}$(".scoreSection #grand_total").length>0&&$(".scoreSection #grand_total").text(e),$("#slidingAggregator #grand_total").length>0&&$("#slidingAggregator #grand_total").text(e)}}}();$(function(){const e={resizable:!0,classes:{"ui-dialog":"my-dialog","ui-dialog-titlebar":"my-dialog-header"},modal:!0,stack:!0,sticky:!0,position:{my:"center",at:"center",of:window},buttons:[{text:"Close",click:function(){$(this).dialog("close")}}]};$("input[type=date]").each(function(){const e=$(this);e.on("change",function(){if(""!==e.val()){const t=$("button.calendarReset[data-target="+e.prop("id")+"]");0!==t.length&&t.prop("disabled",!1)}})}),$(".calendarReset").on("click",function(e){const t=$(this),o=$("#"+t.data("target"));console.log("reset "+o.prop("id"),o);const i=-1!==o.prop("id").indexOf("Q12B");o.length>0&&(o.val(""),t.prop("disabled",!0),i?(console.log("raise change() to let branching.Q12B_blank_then_Lock_Discharge() handle the change() event"),o.change()):(console.log("reset "+o.prop("type")+" "+o.prop("id")),commonUtility.resetControlValue(o))),e.preventDefault()}),$("select").each(function(){const e=$(this);e.on("change",function(){-1!==e.val()&&formController.breakLongSentence(e)})}),$("#questionTab").hover(function(){$("#questionTab").css({left:"0px","transition-duration":"1s"})},function(){$("#questionTab").css({left:"-245px","transition-duration":"1s"})}),$("#rotateSlidingAggregatorHandle").on("click",function(){var e;const t=null===(e=$("#stage").val())||void 0===e?void 0:e.toString();console.log(t+" slidingAggregator should slide into view");const o=$("#slidingAggregator");switch(t){case"Episode Of Care":case"New":o.css("width","13.5em");break;case"Interim":case"Follow Up":o.css({width:"7.2em"})}o.css("right","0em")}),$("#closeSlidingAggregator").on("click",function(){const e=$("#stage").val().toString(),t=$("#slidingAggregator");switch(console.log(e+" slidingAggregator should slide out of view"),e){case"Episode Of Care":case"New":t.css("right","-13.5em");break;case"Interim":case"Follow Up":t.css({right:"-7.2em"})}}),$(".gotoSection").each(function(){const e=$(this);e.click(function(){const t=e.data("anchorid");""!=t&&formController.scrollToAnchor(t)})}),$(".section-title").each(function(){const e=$(this);e.click(function(){let t=e.next(),o=t.attr("hidden");t.attr("hidden",!o)})}),$(".child1").each(function(){const e=$(this);e.click(function(){const t=e.next();console.log("thisQuestion",t);const o=t.attr("hidden");console.log("thisQuestion hidden",o),t.attr("hidden",!o)})}),$(".persistable").on("change",function(e){const t=$(".persistable[id^=Q12_]"),o=$(".persistable[id^=Q23_]");commonUtility.isEmpty(t)||commonUtility.isEmpty(o)||$("#ajaxPost").removeAttr("disabled")}),$("#ajaxPost").click(function(){formController.validate&&formController.submitTheForm($(this),e)}),formController.selfCareScore(),$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){$(this).on("change",function(){formController.selfCareScore(),formController.grandTotal()})}),formController.mobilityScore(),$(".persistable[id^=GG0170]:not([id*=Discharge_Goal])").each(function(){$(this).on("change",function(){formController.mobilityScore(),formController.grandTotal()})}),formController.grandTotal()});