import{Utility}from"./utility.js";import{UserAnswer}from"./userAnswer.js";import{AjaxPostbackModel}from"./ajaxPostbackModel.js";$(function(){$(".persistable").change(function(){const e=new Date($(".persistable[data-questionkey^='Q23']").val().toString()),t=new Date($(".persistable[data-questionkey^='Q12']").val().toString()),o=new Utility;o.isDate(e)&&o.isDate(t)&&$("#ajaxPost").removeAttr("disabled")}),$("select").each(function(){const e=$(this);e.change(function(){formController.breakLongSentence(e)})}),$("#questionTab").hover(function(){$("#questionTab").css({left:"0px","transition-duration":"1s"})},function(){$("#questionTab").css({left:"-230px","transition-duration":"1s"})}),$(".gotoSection").each(function(){const e=$(this);e.click(function(){const t=e.data("anchorid");""!=t&&formController.scrollToAnchor(t)})}),$(".section-title").each(function(){const e=$(this);e.click(function(){let t=e.next(),o=t.attr("hidden");t.attr("hidden",!o)})}),$(".child1").each(function(){const e=$(this);e.click(function(){const t=e.next();console.log("thisQuestion",t);const o=t.attr("hidden");console.log("thisQuestion hidden",o),t.attr("hidden",!o)})}),$("#ajaxPost").click(function(){formController.validate&&formController.submitTheForm($(this))}),formController.selfCareScore(),$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){$(this).change(function(){formController.selfCareScore(),formController.grandTotal()})}),formController.mobilityScore(),$(".persistable[id^=GG0170]:not([id*=Discharge_Goal])").each(function(){$(this).change(function(){formController.mobilityScore(),formController.grandTotal()})}),formController.grandTotal()});let formController=function(){const e=new Utility;function t(e,t){let o;o=$(e.siblings("i.score")),t<=0?o.length>0&&o.remove():0==o.length?e.parent().closest("div").append("<i class='score'>score: "+t+"<i>"):o.text("score: "+t)}function o(){let o=0;return $(".persistable[id^=GG0170]:not([id*=Discharge_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){let r=$(this),a=e.getControlValue(r),i=r.prop("id");switch(!0){case a>=7:i.indexOf("GG0170I")>=0?t(r,0):(t(r,1),o+=1);break;case a>0&&a<=6:t(r,a),o+=a;break;default:t(r,0)}}),o}function r(o){let r,a,i,n=1,s=0,l=0,c=0,d=0,g=0;return"Base"==o?(r=$(".persistable[id^=GG0170I_Admission_Performance]"),a=$(".persistable[id^=GG0170R_Admission_Performance]"),i=$(".persistable[id^=GG0170S_Admission_Performance]")):(r=$(".persistable[id^=GG0170I_Interim_Performance], .persistable[id^=GG0170I_Follow_Up_Performance]"),a=$(".persistable[id^=GG0170R_Interim_Performance], .persistable[id^=GG0170R_Follow_Up_Performance]"),i=$(".persistable[id^=GG0170S_Interim_Performance], .persistable[id^=GG0170S_Follow_Up_Performance]")),(c=e.getControlValue(r))>=7&&(n=2),c<=6&&(n=0),isNaN(c)&&(n=1),(d=e.getControlValue(a))>0?(t(a,d*n),s+=d*n):t(a,0),(g=e.getControlValue(i))>0?(t(i,g*n),l+=g*n):t(i,0),s+l}return{scrollToAnchor:function(e){let t=$("#"+e);console.log("scroll to "+e+'.prop("offsetTop"): '+t.prop("offsetTop"),t),console.log(e+".offset().top = "+t.offset().top);let o=t.prop("offsetTop");$("html,body").animate({scrollTop:o},"fast")},setRehabBtns:function(e){let t=0;$.each($(".rehabAction",e),function(){let e=$(this),o=e.prop("title").replace(/Edit/g,"Create"),r=e.prop("href").replace(/Edit/g,"Create");e.prop("title",o),e.prop("href",r),t++;let a=e.prop("class")+" createActionCmd"+t.toString();e.prop("class",a)})},resetRehabBtns:function(e){let t=["primary","info","secondary","success","warning"],o=0;$.each($(".rehabAction",e),function(){let e=$(this),r=e.prop("title").replace(/Create/g,"Edit"),a=e.prop("href").replace(/Create/g,"Edit");e.prop("title",r),e.prop("href",a);let i="";i="badge badge-"+t[o]+" rehabAction",o++,e.prop("class",i)})},breakLongSentence:function(t){let o=t.next("div.longTextOption"),r=t[0].clientWidth,a=t;parseInt(t.prop("value"))<=0?o.text(""):$.each($("option:selected",a),function(){let t=$(this),a=new RegExp("([\\w\\s]{48,}?\\w)\\s?\\b","g"),i=t.text(),n=t.css("font"),s=e.getTextPixels(i,n);if(o.text(""),s>r){let e=i.replace(a,"$1\n");e=e.trim(),$.isNumeric(e.substring(0,1))&&(e=e.substring(e.indexOf(" ")+1)),o.text(e),o.removeClass("invisible")}})},submitTheForm:function(t){t.attr("disabled","true"),$(".spinnerContainer").show();const o=new Array,r=new Array,a=new Array,i=$("#userAnswerForm"),n=$("#stage",i).val().toString(),s=$("#patientID",i).val().toString(),l=$("#patientName",i).val().toString();let c=$("#facilityID",i).val().toString(),d=+$("#episodeID",i).val(),g=new Date($(".persistable[data-questionkey^='Q23']").val().toString()),f=new Date($(".persistable[data-questionkey^='Q12']").val().toString());if(c){let e=c.split("(")[2],t=e.indexOf(")");c=e.substr(0,t)}const p=$(".persistable");let _=0;"new"==n.toLowerCase()&&(d=-1),p.each(function(){var t,i;_++;const n=$(this),c=n.data("questionkey");let p=new UserAnswer,u=null===(t=n.data("oldvalue"))||void 0===t?void 0:t.toString(),h="";if(-1==+(h=null===(i=e.getControlValue(n,"default"))||void 0===i?void 0:i.toString())&&(h=""),e.isTheSame(n,u,h))return;console.log("--------- continue (not equal) ---------");const m=+n.data("questionid"),b=n.prop("type"),S=n.data("answerid"),A=+n.data("measureid"),G=n.data("measuredescription"),C=n.data("codesetdescription"),x=+n.data("answersequence"),D=n.data("userid");switch(p.PatientName=l,p.PatientID=s,p.EpisodeID=d,p.OnsetDate=g,p.AdmissionDate=f,p.QuestionID=m,p.QuestionKey=c,p.MeasureID=A,p.MeasureName=G,p.AnswerCodeSetDescription=C,x&&(p.AnswerSequenceNumber=x),p.AnswerByUserID=D,p.LastUpdate=new Date,b){case"text":case"date":case"textarea":case"number":p.AnswerCodeSetID=+n.data("codesetid"),p.OldAnswerCodeSetID=+n.data("codesetid"),p.Description=h;break;default:p.AnswerCodeSetID=+h,p.OldAnswerCodeSetID=+u}switch(console.log("("+_+") "+c,p),e.getCRUD(n,u,h)){case"C":r.push(p);break;case"D1":case"D2":p.AnswerID=+S,o.push(p);break;case"U":p.AnswerID=+S,a.push(p)}}),$(".spinnerContainer").hide();let u={resizable:!0,classes:{"ui-dialog":"my-dialog","ui-dialog-titlebar":"my-dialog-header"},modal:!0,stack:!0,sticky:!0,position:{my:"center",at:"center",of:window},buttons:[{text:"Close",click:function(){$(this).dialog("close")}}]},h=new AjaxPostbackModel;h.EpisodeID=d,h.FacilityID=c,h.NewAnswers=r,h.OldAnswers=o,h.UpdatedAnswers=a,console.log("postBackModel",h);let m=t.data("apibaseurl"),b=t.data("controller"),S=m+"/api/"+b;-1===d&&(S=m+"/api/"+b+"/PostNewEpisode"),$(".spinnerContainer").show(),$.ajax({type:"POST",url:S,data:JSON.stringify(h),headers:{RequestVerificationToken:$('input[name="X-CSRF-TOKEN-IPREHAB"]').val().toString(),Accept:"application/json"},contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0}).done(function(e){$(".spinnerContainer").hide(),$.parseJSON(e),-1===d&&$("#episodeID").val(e.id),console.log("postback result",e),u.title="Success",$("#dialog").text("Data is saved.").dialog(u),$(".rehabAction").removeAttr("disabled")}).fail(function(e){$(".spinnerContainer").hide(),t.attr("disabled","false"),console.log("postback error",e),u.title=e.statusText,u.classes={"ui-dialog":"my-dialog","ui-dialog-titlebar":"my-dialog-header"},"OK"==e.statusText||"Ok"==e.statusText?$("#dialog").text("Data is saved.").dialog(u):$("#dialog").text("Data is not saved. "+e.responseText).dialog(u)})},validate:function(e){e.validate()},selfCareScore:function(){let o=0,r=0,a=0;$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){const i=$(this),n=$(this).prop("id"),s=e.getControlValue(i);switch(!0){case s>=7:t(i,1),n.indexOf("Admission")>=0?o+=1:n.indexOf("Discharge")>=0?r+=1:a+=1;break;case s>0&&s<=6:t(i,s),n.indexOf("Admission")>=0?o+=s:n.indexOf("Discharge")>=0?r+=s:a+=s;break;default:t(i,0)}}),$("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Self_Care_Aggregate_Score_Discharge_Performance").length>0?($("#Self_Care_Aggregate_Score_Admission_Performance").text(o),$("#Self_Care_Aggregate_Score_Discharge_Performance").text(r),$("#Self_Care_Aggregate_Score_Total_Change").text(r-o)):$("#Self_Care_Aggregate_Score").text(a)},mobilityScore:function(){if($("#Mobility_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Discharge_Performance").length>0){let a=0,i=0;a+=o(),a+=r("Base"),i+=function(){let o=0;return $(".persistable[id^=GG0170]:not([id*=Admission_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){let r=$(this),a=e.getControlValue(r),i=r.prop("id");switch(!0){case a>=7:i.indexOf("GG0170I")>=0?t(r,0):(t(r,1),o+=1);break;case a>0&&a<=6:t(r,a),o+=a;break;default:t(r,0)}}),o}(),i+=function(){let o=1,r=0,a=0,i=$(".persistable[id^=GG0170I_Discharge_Performance]"),n=e.getControlValue(i);n>=7&&(o=2),n<=6&&(o=0),isNaN(n)&&(o=1);let s=$(".persistable[id^=GG0170R_Discharge_Performance]"),l=e.getControlValue(s);l>0?(t(s,l*o),r+=l*o):t(s,0);let c=$(".persistable[id^=GG0170S_Discharge_Performance]"),d=e.getControlValue(c);return d>0?(t(c,d*o),a+=d*o):t(c,0),r+a}(),$("#Mobility_Aggregate_Score_Admission_Performance").text(a),$("#Mobility_Aggregate_Score_Discharge_Performance").text(i),$("#Mobility_Aggregate_Score_Total_Change").text(i-a)}else{let e=0;e+=o(),e+=r("Interim or Follow Up"),$("#Mobility_Aggregate_Score").text(e)}},updateScore:t,grandTotal:function(){let e=0;if($("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Admission_Performance").length>0){const t=$("#Self_Care_Aggregate_Score_Admission_Performance").text(),o=parseInt(t),r=$("#Mobility_Aggregate_Score_Admission_Performance").text(),a=o+parseInt(r);$("#Admission_Performance_Grand_Total").length>0&&$("#Admission_Performance_Grand_Total").text(a);const i=$("#Self_Care_Aggregate_Score_Discharge_Performance").text(),n=parseInt(i),s=$("#Mobility_Aggregate_Score_Discharge_Performance").text(),l=n+parseInt(s);$("#Discharge_Performance_Grand_Total").length>0&&$("#Discharge_Performance_Grand_Total").text(l),e=l-a}else{const t=$("#Self_Care_Aggregate_Score").text(),o=parseInt(t),r=$("#Mobility_Aggregate_Score").text();e=o+parseInt(r)}$("#Grand_Total").length>0&&$("#Grand_Total").text(e)}}}();