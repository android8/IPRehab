import{Utility,UserAnswer,AjaxPostbackModel}from"./commonImport.js";const formController=function(){const e=new Utility;function t(e,t){const o=$(e.siblings("i.score"));t<=0?o.length>0&&o.remove():0===o.length?e.parent().closest("div").append("<i class='score'>score: "+t+"<i>"):o.text("score: "+t)}function o(){let o=0;return $(".persistable[id^=GG0170]:not([id*=Discharge_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){const a=$(this),n=e.getControlValue(a),i=a.prop("id");switch(!0){case n>=7:i.indexOf("GG0170I")>=0?t(a,0):(t(a,1),o+=1);break;case n>0&&n<=6:t(a,n),o+=n;break;default:t(a,0)}}),o}function a(o){let a,n,i,r=1,s=0,l=0,c=0,d=0,g=0;return"Base"===o?(a=$(".persistable[id^=GG0170I_Admission_Performance]"),n=$(".persistable[id^=GG0170R_Admission_Performance]"),i=$(".persistable[id^=GG0170S_Admission_Performance]")):(a=$(".persistable[id^=GG0170I_Interim_Performance], .persistable[id^=GG0170I_Follow_Up_Performance]"),n=$(".persistable[id^=GG0170R_Interim_Performance], .persistable[id^=GG0170R_Follow_Up_Performance]"),i=$(".persistable[id^=GG0170S_Interim_Performance], .persistable[id^=GG0170S_Follow_Up_Performance]")),(c=e.getControlValue(a))>=7&&(r=2),c<=6&&(r=0),isNaN(c)&&(r=1),(d=e.getControlValue(n))>0?(t(n,d*r),s+=d*r):t(n,0),(g=e.getControlValue(i))>0?(t(i,g*r),l+=g*r):t(i,0),s+l}return{scrollToAnchor:function(e){const t=$("#"+e).prop("offsetTop");$("html,body").animate({scrollTop:t},"fast")},breakLongSentence:function(t){const o=t.next("div.longTextOption"),a=t[0].clientWidth,n=t;parseInt(t.prop("value"))<=0?o.text(""):$.each($("option:selected",n),function(){const t=$(this),n=new RegExp("([\\w\\s]{48,}?\\w)\\s?\\b","g"),i=t.text(),r=t.css("font"),s=e.getTextPixels(i,r);if(o.text(""),s>a){let e=i.replace(n,"$1\n");e=e.trim(),$.isNumeric(e.substring(0,1))&&(e=e.substring(e.indexOf(" ")+1)),o.text(e),o.removeClass("invisible")}})},submitTheForm:function(t,o){t.attr("disabled","true"),$(".spinnerContainer").show();const a=new Array,n=new Array,i=new Array,r=$("#userAnswerForm"),s=$("#patientID",r).val().toString(),l=$("#patientName",r).val().toString();let c=$("#facilityID",r).val().toString(),d=+$("#episodeID",r).val();const g=new Date($(".persistable[data-questionkey^='Q23']").val().toString()),_=new Date($(".persistable[data-questionkey^='Q12']").val().toString());if(c){const e=c.split("(")[2],t=e.indexOf(")");c=e.substr(0,t)}const f=$(".persistable");let u=0;f.each(function(){var t,o;u++;const r=$(this),c=r.data("questionkey"),f=new UserAnswer,m=null===(t=r.data("oldvalue"))||void 0===t?void 0:t.toString();let p="";if(-1==+(p=null===(o=e.getControlValue(r,"default"))||void 0===o?void 0:o.toString())&&(p=""),e.isTheSame(r,m,p))return;console.log("--------- continue (not equal) ---------");const h=+r.data("questionid"),b=r.prop("type"),S=r.data("answerid"),A=+r.data("measureid"),G=r.data("measuredescription"),D=r.data("codesetdescription"),x=+r.data("answersequence"),C=r.data("userid");switch(f.PatientName=l,f.PatientID=s,f.EpisodeID=d,f.OnsetDate=g,f.AdmissionDate=_,f.QuestionID=h,f.QuestionKey=c,f.MeasureID=A,f.MeasureName=G,f.AnswerCodeSetDescription=D,x&&(f.AnswerSequenceNumber=x),f.AnswerByUserID=C,f.LastUpdate=new Date,b){case"text":case"date":case"textarea":case"number":f.AnswerCodeSetID=+r.data("codesetid"),f.OldAnswerCodeSetID=+r.data("codesetid"),f.Description=p;break;default:f.AnswerCodeSetID=+p,f.OldAnswerCodeSetID=+m}switch(console.log("("+u+") "+c,f),e.getCRUD(r,m,p)){case"C":n.push(f);break;case"D1":case"D2":f.AnswerID=+S,a.push(f);break;case"U":f.AnswerID=+S,i.push(f)}}),$(".spinnerContainer").hide();const m=new AjaxPostbackModel;m.EpisodeID=d,m.FacilityID=c,m.NewAnswers=n,m.OldAnswers=a,m.UpdatedAnswers=i,console.log("postBackModel",m);const p=t.data("apibaseurl"),h=t.data("controller");let b;b=-1===d?p+"/api/"+h+"/PostNewEpisode":p+"/api/"+h,$(".spinnerContainer").show(),function(e,a,n){$.ajax({type:"POST",url:e,data:JSON.stringify(a),headers:{RequestVerificationToken:$('input[name="X-CSRF-TOKEN-IPREHAB"]').val().toString(),Accept:"application/json"},contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0}).done(function(e){$(".spinnerContainer").hide(),console.log("postback result",e);const t=$.parseJSON(e);console.log("jsonResult",t),-1===n&&($("#episodeID").val(t),$("#stage").val("Base")),o.title="Success",$("#dialog").text("Data is saved.").dialog(o),$(".rehabAction").removeAttr("disabled")}).fail(function(e){$(".spinnerContainer").hide(),t.attr("disabled","false"),console.log("postback error",e),o.title=e.statusText,o.classes={"ui-dialog":"my-dialog","ui-dialog-titlebar":"my-dialog-header"},"OK"===e.statusText||"Ok"===e.statusText?$("#dialog").text("Data is saved.").dialog(o):$("#dialog").text("Data is not saved. "+e.responseText).dialog(o)})}(b,m,d)},validate:function(e){e.validate()},selfCareScore:function(){let o=0,a=0,n=0;$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){const i=$(this),r=$(this).prop("id"),s=e.getControlValue(i);switch(!0){case s>=7:t(i,1),r.indexOf("Admission")>=0?o+=1:r.indexOf("Discharge")>=0?a+=1:n+=1;break;case s>0&&s<=6:t(i,s),r.indexOf("Admission")>=0?o+=s:r.indexOf("Discharge")>=0?a+=s:n+=s;break;default:t(i,0)}}),$("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Self_Care_Aggregate_Score_Discharge_Performance").length>0?($("#Self_Care_Aggregate_Score_Admission_Performance").text(o),$("#Self_Care_Aggregate_Score_Discharge_Performance").text(a),$("#Self_Care_Aggregate_Score_Total_Change").text(a-o)):$("#Self_Care_Aggregate_Score").text(n)},mobilityScore:function(){if($("#Mobility_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Discharge_Performance").length>0){let n=0,i=0;n+=o(),n+=a("Base"),i+=function(){let o=0;return $(".persistable[id^=GG0170]:not([id*=Admission_Performance]):not([id*=Discharge_Goal]):not([id*=GG0170Q]):not([id*=GG0170R]):not([id*=GG0170S])").each(function(){const a=$(this),n=e.getControlValue(a),i=a.prop("id");switch(!0){case n>=7:i.indexOf("GG0170I")>=0?t(a,0):(t(a,1),o+=1);break;case n>0&&n<=6:t(a,n),o+=n;break;default:t(a,0)}}),o}(),i+=function(){let o=1,a=0,n=0;const i=$(".persistable[id^=GG0170I_Discharge_Performance]"),r=e.getControlValue(i);r>=7&&(o=2),r<=6&&(o=0),isNaN(r)&&(o=1);const s=$(".persistable[id^=GG0170R_Discharge_Performance]"),l=e.getControlValue(s);l>0?(t(s,l*o),a+=l*o):t(s,0);const c=$(".persistable[id^=GG0170S_Discharge_Performance]"),d=e.getControlValue(c);return d>0?(t(c,d*o),n+=d*o):t(c,0),a+n}(),$("#Mobility_Aggregate_Score_Admission_Performance").text(n),$("#Mobility_Aggregate_Score_Discharge_Performance").text(i),$("#Mobility_Aggregate_Score_Total_Change").text(i-n)}else{let e=0;e+=o(),e+=a("Interim or Follow Up"),$("#Mobility_Aggregate_Score").text(e)}},updateScore:t,grandTotal:function(){let e=0;if($("#Self_Care_Aggregate_Score_Admission_Performance").length>0&&$("#Mobility_Aggregate_Score_Admission_Performance").length>0){const t=$("#Self_Care_Aggregate_Score_Admission_Performance").text(),o=parseInt(t),a=$("#Mobility_Aggregate_Score_Admission_Performance").text(),n=o+parseInt(a);$("#Admission_Performance_Grand_Total").length>0&&$("#Admission_Performance_Grand_Total").text(n);const i=$("#Self_Care_Aggregate_Score_Discharge_Performance").text(),r=parseInt(i),s=$("#Mobility_Aggregate_Score_Discharge_Performance").text(),l=r+parseInt(s);$("#Discharge_Performance_Grand_Total").length>0&&$("#Discharge_Performance_Grand_Total").text(l),e=l-n}else{const t=$("#Self_Care_Aggregate_Score").text(),o=parseInt(t),a=$("#Mobility_Aggregate_Score").text();e=o+parseInt(a)}$("#Grand_Total").length>0&&$("#Grand_Total").text(e)}}}();$(function(){const e={resizable:!0,classes:{"ui-dialog":"my-dialog","ui-dialog-titlebar":"my-dialog-header"},modal:!0,stack:!0,sticky:!0,position:{my:"center",at:"center",of:window},buttons:[{text:"Close",click:function(){$(this).dialog("close")}}]};$(".persistable").change(function(){const t=new Date("2021-01-01 00:00:00"),o=new Date($(".persistable[data-questionkey^='Q23']").val().toString()),a=new Date($(".persistable[data-questionkey^='Q12']").val().toString()),n=new Utility;n.isDate(o)&&n.isDate(a)?o>t&&a>t&&a>=o?$("#ajaxPost").removeAttr("disabled"):$("#dialog").text("Onset Date must be same or earlier than Admit Date, and both dates must be later than 01/01/2021 00:00:00").dialog(e):$("#dialog").text("Onset Date and Admit Date must be valid dates.").dialog(e)}),$("select").each(function(){const e=$(this);e.change(function(){-1!==e.val()&&formController.breakLongSentence(e)})}),$("#questionTab").hover(function(){$("#questionTab").css({left:"0px","transition-duration":"1s"})},function(){$("#questionTab").css({left:"-230px","transition-duration":"1s"})}),$(".gotoSection").each(function(){const e=$(this);e.click(function(){const t=e.data("anchorid");""!=t&&formController.scrollToAnchor(t)})}),$(".section-title").each(function(){const e=$(this);e.click(function(){let t=e.next(),o=t.attr("hidden");t.attr("hidden",!o)})}),$(".child1").each(function(){const e=$(this);e.click(function(){const t=e.next();console.log("thisQuestion",t);const o=t.attr("hidden");console.log("thisQuestion hidden",o),t.attr("hidden",!o)})}),$("#ajaxPost").click(function(){formController.validate&&formController.submitTheForm($(this),e)}),formController.selfCareScore(),$(".persistable[id^=GG0130]:not([id*=Discharge_Goal])").each(function(){$(this).change(function(){formController.selfCareScore(),formController.grandTotal()})}),formController.mobilityScore(),$(".persistable[id^=GG0170]:not([id*=Discharge_Goal])").each(function(){$(this).change(function(){formController.mobilityScore(),formController.grandTotal()})}),formController.grandTotal()});